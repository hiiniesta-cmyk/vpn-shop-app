<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è TWA -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Shinobu Proxy - –¢–∞—Ä–∏—Ñ—ã –∏ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js?v=2.2"></script>
    
    <!-- Firebase Imports for Firestore -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // setLogLevel –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∏–∑ firebase-firestore
        import { getFirestore, doc, onSnapshot, setDoc, serverTimestamp, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // –í–ê–ñ–ù–û: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Ä–æ–≤–Ω—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ Firestore
        setLogLevel('debug');

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let userId = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: —Å–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ custom token, –∏–Ω–∞—á–µ –∞–Ω–æ–Ω–∏–º–Ω–æ
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Firebase UID)
                userId = auth.currentUser?.uid || crypto.randomUUID();
                
                console.log("Firebase initialized. User ID:", userId);
                
                // --- –ü–ï–†–ï–î–ê–ß–ê –í –ì–õ–û–ë–ê–õ–¨–ù–´–ô –°–ö–û–£–ü ---
                window.db = db;
                window.auth = auth;
                window.firebaseUserId = userId; 
                // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω—É–∂–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ Firestore –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
                window.firestore = { doc, onSnapshot, setDoc, serverTimestamp, getDoc, setLogLevel }; 

                // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏
                window.startSubscriptionListener();

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", error);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                document.getElementById('status-info').innerHTML = 
                    `<span style="color: #ef4444;">‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. ${error.message}</span>`;
            }
        }

        // --- Mock-—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ ---
        window.mockUpdateSubscription = async function(telegramId, months) {
            if (!window.db || !telegramId || !window.firebaseUserId || !window.firestore) return;

            const subscriptionRef = window.firestore.doc(window.db, `artifacts/${window.appId}/users/${window.firebaseUserId}/subscription/status_doc`);
            
            try {
                const docSnap = await window.firestore.getDoc(subscriptionRef);
                let existingData = docSnap.exists() ? docSnap.data() : {};

                let expiryDate = new Date();
                
                // –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞, –ø—Ä–æ–¥–ª–µ–≤–∞–µ–º —Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –∏—Å—Ç–µ—á–µ–Ω–∏—è
                if (existingData.status === 'active') {
                    const currentExpiry = existingData.expiry_date;
                    if (currentExpiry && currentExpiry.toDate() > expiryDate) {
                        expiryDate = currentExpiry.toDate();
                    }
                }
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–∞—Ç—É –∏—Å—Ç–µ—á–µ–Ω–∏—è –Ω–∞ N –º–µ—Å—è—Ü–µ–≤
                expiryDate.setMonth(expiryDate.getMonth() + months);
                
                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è VLESS-—Å—Å—ã–ª–∫–∏ 
                const uuid = crypto.randomUUID();
                const mockVlessLink = `vless://${uuid}@server.shinobu.net:443?security=tls&fp=chrome&sni=server.shinobu.net#Shinobu_Proxy_${months}m_TG${telegramId}`;

                const subscriptionData = {
                    telegram_id: telegramId,
                    status: 'active',
                    expiry_date: expiryDate,
                    vless_link: mockVlessLink,
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º trial_used, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –±—ã–ª true
                    trial_used: existingData.trial_used || false, 
                    // NEW: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º invited_count, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                    invited_count: existingData.invited_count || 0, 
                    last_updated: window.firestore.serverTimestamp()
                };

                await window.firestore.setDoc(subscriptionRef, subscriptionData, { merge: true });
                console.log(`Mock subscription updated for ${telegramId} for ${months} months.`);
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –≤ mockUpdateSubscription:", error);
                window.showModal('–û—à–∏–±–∫–∞ Firebase', `–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤ –±–∞–∑–µ. ${error.message}`, '–û–ö');
            }
        }
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
        initializeFirebase();

    </script>
    
    <!-- –°—Ç–∏–ª–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Tailwind-–ø–æ–¥–æ–±–Ω—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ -->
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            /* –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–º–Ω–æ–π –∏ —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã */
            --bg-dark: #0d0d0d;
            --bg-light: #f5f7fa;
            --text-dark: #e0e0e0;
            --text-light: #2d3748;
            --accent-color: #00d4ff; /* –ì–æ–ª—É–±–æ–π */
            --accent-dark: #00a8cc;
            --secondary-color: #7b2cbf; /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π */
            --card-dark: rgba(255, 255, 255, 0.03);
            --card-light: rgba(255, 255, 255, 0.9);
            --border-dark: rgba(0, 212, 255, 0.3);
            --border-light: rgba(0, 123, 255, 0.3);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-dark);
            color: var(--text-dark);
            min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
            position: relative;
        }

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É */
        body.light-theme {
            background: var(--bg-light);
            color: var(--text-light);
        }
        body.light-theme .tagline { color: #555; }
        body.light-theme .logo { filter: drop-shadow(0 0 5px rgba(0, 123, 255, 0.2)); }
        body.light-theme .section-title { color: #007bff; border-bottom-color: var(--border-light); }
        body.light-theme .card { 
            background: var(--card-light); 
            border-color: var(--border-light); 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); 
            color: var(--text-light);
        }
        body.light-theme .btn { 
            background: rgba(0, 123, 255, 0.1); 
            border-color: #007bff; 
            color: #007bff; 
        }
        body.light-theme .btn:hover { 
            background: rgba(0, 123, 255, 0.25); 
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.4); 
        }
        body.light-theme .vless-container { background: #e2e8f0; border-color: #3182ce; }
        body.light-theme .vless-link-box { color: var(--text-light); }
        body.light-theme .grid-background { 
            background-image: linear-gradient(rgba(0, 123, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 123, 255, 0.05) 1px, transparent 1px);
        }
        body.light-theme .orb1 { background: radial-gradient(circle, rgba(0, 123, 255, 0.25), transparent); }
        body.light-theme .orb2 { background: radial-gradient(circle, rgba(99, 102, 241, 0.2), transparent); }


        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
        header { text-align: center; padding: 30px 0 20px; position: relative; }
        .logo {
            font-size: 2.2em;
            font-weight: bold;
            background: linear-gradient(45deg, var(--accent-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.3));
        }
        .tagline { font-size: 1em; color: #b0b0b0; margin-top: 5px; transition: color 0.3s; }

        /* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã */
        .theme-toggle {
            position: absolute;
            top: 25px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--accent-color);
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
            line-height: 1;
        }
        .theme-toggle:hover {
            color: var(--accent-dark);
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }
        body.light-theme .theme-toggle { color: #555; }
        body.light-theme .theme-toggle:hover { color: #000; background: rgba(0, 0, 0, 0.05); }


        /* –û–±—â–∞—è —Å–µ–∫—Ü–∏—è */
        .section-title {
            font-size: 1.8em;
            color: var(--accent-color);
            margin: 30px 0 20px;
            border-bottom: 2px solid var(--border-dark);
            padding-bottom: 10px;
            text-align: center;
            transition: color 0.3s, border-bottom-color 0.3s;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ */
        .card {
            background: var(--card-dark);
            border: 1px solid var(--border-dark);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        /* –°–µ—Ç–∫–∏ */
        .grid { display: grid; gap: 15px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            padding: 12px 20px;
            background: rgba(0, 212, 255, 0.1);
            border: 2px solid var(--accent-color);
            color: var(--accent-color);
            text-decoration: none;
            font-size: 1em;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
            flex-direction: column;
        }

        .btn:hover {
            background: rgba(0, 212, 255, 0.25);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
            transform: translateY(-2px);
        }

        .btn-price { font-weight: bold; display: block; margin-top: 5px; font-size: 1.1em; }
        .btn-icon { font-size: 1.5em; margin-bottom: 5px; }

        /* –ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ (6 –º–µ—Å—è—Ü–µ–≤) */
        .tariff-card:nth-child(4) .btn { 
            background: linear-gradient(90deg, #7b2cbf, var(--accent-color));
            color: #fff;
            border-color: var(--secondary-color);
            box-shadow: 0 0 20px rgba(123, 44, 191, 0.5);
        }
        .tariff-card:nth-child(4) .btn:hover { background: linear-gradient(90deg, #6a24aa, var(--accent-dark)); }
        body.light-theme .tariff-card:nth-child(4) .btn {
            background: linear-gradient(90deg, #6c5ce7, #007bff);
            border-color: #6c5ce7;
        }
        
        /* –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ */
        .status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .status-indicator { padding: 5px 15px; border-radius: 8px; font-weight: bold; font-size: 0.9em; transition: background 0.3s; }
        .status-inactive { background-color: #e53e3e; color: white; }
        .status-active { background-color: #38a169; color: white; }
        .status-loading { background-color: #3182ce; color: white; }

        /* VLESS Key Display */
        .vless-container { 
            display: flex; gap: 10px; align-items: center; 
            margin-top: 15px; 
            padding: 15px;
            border-radius: 10px;
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid var(--border-dark);
            transition: background 0.3s, border-color 0.3s;
        }
        .vless-link-box {
            flex-grow: 1;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }
        .vless-copy-btn {
            flex-shrink: 0;
            padding: 10px 15px;
            font-size: 0.9em;
            background: #2b6cb0;
            border-color: #2b6cb0;
            color: white;
            justify-content: center;
        }
        .vless-copy-btn:hover { background: #1e4e7c; }

        /* –§–æ–Ω –∏ –∞–Ω–∏–º–∞—Ü–∏—è */
        .grid-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 0;
            pointer-events: none;
            transition: background-image 0.3s;
        }
        .orb { position: fixed; border-radius: 50%; filter: blur(80px); opacity: 0.4; z-index: 0; pointer-events: none; transition: background 0.3s; }
        .orb1 { width: 400px; height: 400px; background: radial-gradient(circle, #00d4ff, transparent); top: -200px; left: -200px; }
        .orb2 { width: 500px; height: 500px; background: radial-gradient(circle, #7b2cbf, transparent); bottom: -250px; right: -250px; }
        
        /* –ú–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å—ã */
        @media (max-width: 600px) {
            .grid-4 { grid-template-columns: 1fr 1fr; }
            .grid-2 { grid-template-columns: 1fr; }
            .vless-container { flex-direction: column; align-items: stretch; }
            .vless-copy-btn { width: 100%; margin-top: 10px; }
        }
    </style>
</head>
<body>
    <!-- Animated background -->
    <div class="grid-background"></div>
    <div class="orb orb1"></div>
    <div class="orb orb2"></div>

    <div class="container">
        <!-- Header -->
        <header>
            <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã -->
            <button class="theme-toggle" id="theme-toggle" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
                <!-- SVG-–∏–∫–æ–Ω–∫–∞ –õ—É–Ω—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - —Ç–µ–º–Ω–∞—è —Ç–µ–º–∞) -->
                <svg id="moon-icon" style="display:block;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                <!-- SVG-–∏–∫–æ–Ω–∫–∞ –°–æ–ª–Ω—Ü–∞ (–¥–ª—è —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã) -->
                <svg id="sun-icon" style="display:none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
            </button>
            
            <div class="logo">üîí Shinobu Proxy</div>
            <div class="tagline">–í–∞—à–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å ‚Äî –Ω–∞—à –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</div>
            <div style="font-size: 0.8em; margin-top: 10px; opacity: 0.7;">
                –í–∞—à Telegram ID –¥–ª—è –æ–ø–ª–∞—Ç—ã: <span id="telegram-id-display">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
        </header>

        <!-- 1. –°—Ç–∞—Ç—É—Å –ü–æ–¥–ø–∏—Å–∫–∏ –∏ –ö–ª—é—á -->
        <section class="subscription-status-section">
            <h2 class="section-title">‚ú® –í–∞—à –°—Ç–∞—Ç—É—Å –∏ –ö–ª—é—á</h2>
            <div class="card">
                <div class="status-header">
                    <h3>–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:</h3>
                    <div id="status-indicator" class="status-indicator status-loading">–ó–∞–≥—Ä—É–∑–∫–∞</div>
                </div>
                <div id="status-info" style="margin-top: 10px; line-height: 1.6;">
                    <p>–î–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è: <span id="expiry-date">...</span></p>
                    <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (Firebase ID): <span id="firebase-user-id">...</span></p>
                </div>

                <!-- –ë–ª–æ–∫ —Å VLESS-—Å—Å—ã–ª–∫–æ–π -->
                <div id="vless-container" class="vless-container">
                    <div class="vless-link-box" id="vless-link-display">
                        –ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª—é—á–∞...
                    </div>
                    <button class="btn vless-copy-btn" onclick="copyVlessLink()">
                        üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
            </div>
        </section>

        <!-- 2. –ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (NEW) -->
        <section class="trial-section">
            <h2 class="section-title">üéÅ –ü—Ä–æ–±–Ω—ã–π –ü–µ—Ä–∏–æ–¥</h2>
            <div class="card" id="trial-card-status">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω JS -->
                <div style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...</div>
            </div>
        </section>

        <!-- 3. –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ü—Ä–æ–≥—Ä–∞–º–º–∞ (NEW) -->
        <section class="referral-section">
            <h2 class="section-title">ü§ù –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ü—Ä–æ–≥—Ä–∞–º–º–∞</h2>
            <div class="card">
                <!-- NEW: –°—á–µ—Ç—á–∏–∫ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
                <h3 id="invited-count-display" style="font-size: 1.1em; color: var(--accent-color); margin-bottom: 15px; text-align: center;">
                    –ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 0
                </h3>
                
                <p style="margin-bottom: 15px; font-size: 0.95em;">
                    –ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–∑–µ–π! –ö–æ–≥–¥–∞ –¥—Ä—É–≥ –æ–ø–ª–∞—Ç–∏—Ç –ø–æ–¥–ø–∏—Å–∫—É –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ, –≤—ã –æ–±–∞ –ø–æ–ª—É—á–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–Ω–∏ –≤ –ø–æ–¥–∞—Ä–æ–∫.
                </p>
                
                <h3 style="font-size: 1.1em; color: var(--accent-color); margin-bottom: 10px;">–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:</h3>
                
                <div class="vless-container" id="referral-container" style="background: rgba(123, 44, 191, 0.05);">
                    <div class="vless-link-box" id="referral-link-display" style="font-size: 0.85em; opacity: 0.9; color: var(--accent-color);">
                        –ó–∞–≥—Ä—É–∑–∫–∞...
                    </div>
                    <button class="btn vless-copy-btn" id="copy-referral-btn" style="background: var(--secondary-color); border-color: var(--secondary-color);">
                        üîó –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
            </div>
        </section>

        <!-- 4. –¢–∞—Ä–∏—Ñ—ã –∏ –û–ø–ª–∞—Ç–∞ -->
        <section class="tariffs-section">
            <h2 class="section-title">üí≥ –¢–∞—Ä–∏—Ñ—ã –∏ –û–ø–ª–∞—Ç–∞ (YooMoney)</h2>
            <div class="grid grid-2" id="tariff-grid">
                <!-- –¢–∞—Ä–∏—Ñ—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã JS -->
            </div>
            <div class="card" style="text-align: center; font-size: 0.9em; margin-top: 15px; opacity: 0.9; border: 1px dashed var(--secondary-color);">
                 <p><strong>‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï:</strong> –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ YooMoney, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º. 
                 <br>–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ –≤–∞—à–∏–º –±–æ—Ç–æ–º (–¥–æ 1-5 –º–∏–Ω—É—Ç).
                 <br>–í–∞—à Telegram ID –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –ø–æ–∫—É–ø–∫–∏.</p>
            </div>
        </section>

        <!-- 5. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
        <section class="connection-section">
            <h2 class="section-title">üì± –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</h2>

            <!-- –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π -->
            <h3 style="font-size: 1.3em; margin-bottom: 10px; text-align: center;">üì• –°–∫–∞—á–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h3>
            <div class="grid grid-4" id="download-grid">
                <!-- –ö–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã JS -->
            </div>

            <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
            <h3 style="font-size: 1.3em; margin-top: 20px; margin-bottom: 10px; text-align: center;">üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ</h3>
            <div class="grid grid-4" id="instructions-grid">
                <!-- –ö–Ω–æ–ø–∫–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã JS -->
            </div>
        </section>

    </div>
    
    <!-- –°—Ç–∏–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –∑–∞–º–µ–Ω—ã alert/confirm -->
    <style>
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–º—ã */
        #custom-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.7); z-index: 10000; 
            display: flex; justify-content: center; align-items: center;
        }
        #modal-content {
            padding: 25px; border-radius: 12px; max-width: 350px; width: 90%; 
            text-align: center; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5); 
            background: var(--bg-dark); /* –ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–æ–Ω */
            color: var(--text-dark); /* –ò—Å—Ö–æ–¥–Ω—ã–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
            transition: all 0.3s ease;
        }
        .light-theme #modal-content {
            background: var(--bg-light); /* –§–æ–Ω –¥–ª—è —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã */
            color: var(--text-light); /* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã */
        }
        #modal-action-btn {
            padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; 
            cursor: pointer; transition: background 0.2s;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è Toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –≤–Ω–∏–∑—É) */
        .custom-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 10001;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            font-size: 0.9em;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        body.light-theme .custom-toast {
             background: rgba(255, 255, 255, 0.95);
             color: #2d3748;
             border: 1px solid rgba(0, 0, 0, 0.1);
        }

    </style>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let tg = null;
        let telegramId = null; // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram

        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –°–ï–†–í–ò–°–ê
        // ========================================================================
        const YOOMONEY_RECIPIENT_ID = '4100119271147598'; 
        const YOOMONEY_QUICKPAY_URL = 'https://yoomoney.ru/quickpay/confirm.xml';
        const APP_NAME = 'Shinobu Proxy';
        
        // –ù–û–í–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –î–õ–Ø –ü–†–û–ë–ù–û–ì–û –ü–ï–†–ò–û–î–ê –ò –†–ï–§–ï–†–ê–õ–ö–ò
        const BOT_USERNAME = 'ShinobuProxyBot'; // <<< –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –†–ï–ê–õ–¨–ù–û–ï –ò–ú–Ø –í–ê–®–ï–ì–û –ë–û–¢–ê!
        const TRIAL_DAYS = 3;
        // ========================================================================

        const DOWNLOAD_LINKS = {
            android: { name: 'Android', icon: 'ü§ñ', url: 'https://github.com/2dust/v2rayNG/releases' },
            ios: { name: 'iOS (V2RayTun)', icon: 'üçé', url: 'https://apps.apple.com/us/app/v2raytun/id6476628951' },
            windows: { name: 'Windows', icon: 'ü™ü', url: 'https://github.com/hiddify/hiddify-app/releases' },
            mac: { name: 'macOS', icon: 'üíª', url: 'https://github.com/hiddify/hiddify-app/releases' }
        };

        const INSTRUCTION_LINKS = {
            android: { name: 'Android', icon: 'üìñ', url: 'https://telegra.ph/Kak-podklyuchitsya-k-Proxy-10-13' },
            ios: { name: 'iOS', icon: 'üìñ', url: 'https://telegra.ph/Kak-podklyuchitsya-k-Proxy-10-13-5' },
            windows: { name: 'Windows', icon: 'üìñ', url: 'https://telegra.ph/Kak-podklyuchitsya-k-Proxy-10-13-3' },
            faq: { name: 'FAQ', icon: 'üí°', url: 'https://telegra.ph/FAQ-01-01' }
        };

        // –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –¢–ê–†–ò–§–´
        const TARIFFS = [
            { months: 1, price: 103.10 },
            { months: 2, price: 206.19, description: '–í—ã–≥–æ–¥–Ω–æ' },
            { months: 3, price: 309.28, description: '–≠–∫–æ–Ω–æ–º–∏—è' },
            { months: 6, price: 618.56, description: '–°—É–ø–µ—Ä-—ç–∫–æ–Ω–æ–º–∏—è' }
        ];

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ UI —Ñ—É–Ω–∫—Ü–∏–∏ ---
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º—ã
        function applyTheme(isLight) {
            const body = document.body;
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');

            if (isLight) {
                body.classList.add('light-theme');
                if(sunIcon && moonIcon) {
                    sunIcon.style.display = 'block';
                    moonIcon.style.display = 'none';
                }
            } else {
                body.classList.remove('light-theme');
                 if(sunIcon && moonIcon) {
                    sunIcon.style.display = 'none';
                    moonIcon.style.display = 'block';
                }
            }
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä —Ç–µ–º—ã –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã
        document.addEventListener('DOMContentLoaded', () => {
             const themeToggle = document.getElementById('theme-toggle');
             if (themeToggle) {
                 themeToggle.addEventListener('click', () => {
                    const isLight = document.body.classList.contains('light-theme');
                    applyTheme(!isLight);
                 });
             }
        });

        window.addEventListener('load', function() {
            // 1. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π/—Å–∏—Å—Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
            let storedTheme = localStorage.getItem('theme');
            let systemIsLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;

            if (window.Telegram && window.Telegram.WebApp) {
                tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                
                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ç–µ–º–µ Telegram
                if (tg.colorScheme === 'light') {
                    applyTheme(true);
                } else {
                    applyTheme(false);
                }
            } else {
                console.warn('Telegram WebApp API –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.');
                // –ï—Å–ª–∏ –Ω–µ –≤ TWA, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—É—é —Ç–µ–º—É
                if (storedTheme) {
                    applyTheme(storedTheme === 'light');
                } else {
                    applyTheme(systemIsLight);
                }
            }
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ TWA ID
            if (tg && tg.initDataUnsafe.user) {
                telegramId = tg.initDataUnsafe.user.id;
                document.getElementById('telegram-id-display').textContent = telegramId;
            } else {
                telegramId = 'NO_TG_ID_DEV';
                document.getElementById('telegram-id-display').textContent = `${telegramId} (DEV)`;
            }

            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–Ω–æ–ø–æ–∫
            renderTariffs();
            renderDownloadButtons();
            renderInstructionButtons();
            
            // NEW: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
            window.generateReferralLink();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º Firebase ID –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ 
            document.getElementById('firebase-user-id').textContent = window.firebaseUserId || '–û–∂–∏–¥–∞–Ω–∏–µ...';
        });
        
        // –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Firebase
        window.startSubscriptionListener = function() {
            const userId = window.firebaseUserId;
            document.getElementById('firebase-user-id').textContent = userId;
            
            if (!window.db || !userId || !window.firestore) {
                document.getElementById('status-info').innerHTML = 
                    `<span style="color: #ef4444;">‚ùå –û—à–∏–±–∫–∞: –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å. (TG ID: ${telegramId})</span>`;
                return;
            }

            const subscriptionRef = window.firestore.doc(window.db, `artifacts/${window.appId}/users/${userId}/subscription/status_doc`);
            
            // onSnapshot –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            window.firestore.onSnapshot(subscriptionRef, (docSnap) => {
                const indicator = document.getElementById('status-indicator');
                const info = document.getElementById('status-info');
                const vlessLinkDisplay = document.getElementById('vless-link-display');
                
                // --- VLESS –ö–ª—é—á ---
                if (docSnap.exists() && docSnap.data().vless_link) {
                    const data = docSnap.data();
                    vlessLinkDisplay.innerHTML = `<strong>–ö–õ–Æ–ß:</strong> ${data.vless_link}`;
                    vlessLinkDisplay.style.opacity = '1';
                } else {
                    vlessLinkDisplay.innerHTML = '<span style="color: var(--secondary-color);">–ö–ª—é—á –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏.</span>';
                    vlessLinkDisplay.style.opacity = '0.9';
                }

                // --- –°—Ç–∞—Ç—É—Å –ü–æ–¥–ø–∏—Å–∫–∏ ---
                if (docSnap.exists() && docSnap.data().status === 'active') {
                    const data = docSnap.data();
                    const expiryDate = data.expiry_date.toDate();
                    const formattedDate = expiryDate.toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric' });
                    
                    indicator.textContent = '–ê–∫—Ç–∏–≤–Ω–∞ ‚úÖ';
                    indicator.className = 'status-indicator status-active';
                    info.innerHTML = `
                        <p>–î–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è: <span id="expiry-date">${formattedDate}</span></p>
                        <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (Firebase ID): ${userId}</p>
                    `;
                } else {
                    indicator.textContent = '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞ ‚ùå';
                    indicator.className = 'status-indicator status-inactive';
                    info.innerHTML = `
                        <p>–î–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è: <span id="expiry-date">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏</span></p>
                        <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (Firebase ID): ${userId}</p>
                    `;
                }
                
                // --- –°—Ç–∞—Ç—É—Å –ü—Ä–æ–±–Ω–æ–≥–æ –ü–µ—Ä–∏–æ–¥–∞ ---
                const trialCard = document.getElementById('trial-card-status');
                const trialUsed = docSnap.exists() && docSnap.data().trial_used;

                if (trialUsed) {
                    trialCard.innerHTML = `
                        <p style="color: #38a169; font-weight: bold; text-align: center;">‚úÖ –ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω.</p>
                        <p style="font-size: 0.9em; margin-top: 5px; text-align: center;">–ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –∑–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –ü—Ä–∏–æ–±—Ä–µ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Å–µ—Ä–≤–∏—Å–æ–º.</p>
                    `;
                } else {
                    trialCard.innerHTML = `
                        <p style="margin-bottom: 15px; text-align: center;">–ù–∞—á–Ω–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–∞ ${TRIAL_DAYS} –¥–Ω—è, —á—Ç–æ–±—ã –æ—Ü–µ–Ω–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ —Å–≤—è–∑–∏!</p>
                        <button class="btn" style="background: var(--secondary-color); color: white; border-color: var(--secondary-color);" 
                            onclick="startTrial()">
                            üöÄ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å ${TRIAL_DAYS} –¥–Ω—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ
                        </button>
                        <p style="font-size: 0.75em; opacity: 0.7; margin-top: 10px; text-align: center;">–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑.</p>
                    `;
                }

                // --- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ü—Ä–æ–≥—Ä–∞–º–º–∞ (NEW) ---
                const invitedCount = docSnap.exists() && docSnap.data().invited_count !== undefined 
                    ? docSnap.data().invited_count 
                    : 0;
                window.updateReferralUI(invitedCount);

            }, (error) => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏:", error);
                document.getElementById('status-info').innerHTML = 
                    `<span style="color: #ef4444;">‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å. ${error.message}</span>`;
            });
        }

        // NEW: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        window.updateReferralUI = function(count) {
            const displayElement = document.getElementById('invited-count-display');
            if (displayElement) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∫–ª–æ–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ
                displayElement.innerHTML = `–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <strong>${count}</strong>`;
            }
        }

        // --- –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (NEW) ---
        function copyTextToClipboard(text, successMessage) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º document.execCommand('copy') –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –≤ iframe
                document.execCommand('copy');
                window.showToast(successMessage);
            } catch (err) {
                console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç:', err);
                window.showModal('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é.', '–û–ö');
            }
            
            document.body.removeChild(textarea);
        }
        
        // --- –õ–æ–≥–∏–∫–∞ –ö–Ω–æ–ø–æ–∫ ---

        // NEW: –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è VLESS-—Å—Å—ã–ª–∫–∏
        window.copyVlessLink = function() {
            const linkBox = document.getElementById('vless-link-display');
            if (linkBox.textContent.includes('–ö–ª—é—á –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å')) {
                window.showToast('–°–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É!');
                return;
            }
            const link = linkBox.textContent.replace('–ö–õ–Æ–ß:', '').trim(); 
            copyTextToClipboard(link, 'VLESS-—Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
        }

        // NEW: –õ–æ–≥–∏–∫–∞ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ü—Ä–æ–≥—Ä–∞–º–º—ã
        window.generateReferralLink = function() {
            const display = document.getElementById('referral-link-display');
            const button = document.getElementById('copy-referral-btn');
            
            // –°—Å—ã–ª–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –¥–æ–ª–∂–Ω–∞ –≤–µ—Å—Ç–∏ –Ω–∞ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º start=ref_{ID}
            const link = `https://t.me/${BOT_USERNAME}?start=ref_${telegramId}`;
            
            display.textContent = link;
            button.onclick = () => copyTextToClipboard(link, '–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
        }
        
        // NEW: –õ–æ–≥–∏–∫–∞ –ü—Ä–æ–±–Ω–æ–≥–æ –ü–µ—Ä–∏–æ–¥–∞
        window.startTrial = async function() {
            if (!window.db || !telegramId || !window.firebaseUserId || !window.firestore) {
                window.showModal('–û—à–∏–±–∫–∞', '–°–µ—Ä–≤–∏—Å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.', '–û–ö');
                return;
            }

            const subscriptionRef = window.firestore.doc(window.db, `artifacts/${window.appId}/users/${window.firebaseUserId}/subscription/status_doc`);
            
            try {
                const docSnap = await window.firestore.getDoc(subscriptionRef);
                if (docSnap.exists() && docSnap.data().trial_used) {
                    window.showModal('–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥', '–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —Å–≤–æ–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥.', '–ü–æ–Ω—è—Ç–Ω–æ');
                    return;
                }
            } catch (error) {
                 console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ trial_used:", error);
                 window.showModal('–û—à–∏–±–∫–∞ Firebase', `–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞. ${error.message}`, '–û–ö');
                 return;
            }

            window.showModal('–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞', `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å ${TRIAL_DAYS} –¥–Ω—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞? –≠—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑.`, 
                '–ù–∞—á–∞—Ç—å —Å–µ–π—á–∞—Å', 
                async () => {
                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—É –∏—Å—Ç–µ—á–µ–Ω–∏—è: —Å–µ–≥–æ–¥–Ω—è + TRIAL_DAYS
                    let expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() + TRIAL_DAYS);
                    
                    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–ª—é—á–∞ 
                    const uuid = crypto.randomUUID();
                    const mockVlessLink = `vless://${uuid}@trial.shinobu.net:443?security=tls&fp=chrome&sni=trial.shinobu.net#Shinobu_Proxy_Trial${TRIAL_DAYS}d_TG${telegramId}`;

                    const trialData = {
                        telegram_id: telegramId,
                        status: 'active',
                        expiry_date: expiryDate, 
                        vless_link: mockVlessLink,
                        trial_used: true, // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω
                        invited_count: 0, // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–∞
                        last_updated: window.firestore.serverTimestamp()
                    };

                    try {
                        await window.firestore.setDoc(subscriptionRef, trialData, { merge: true });
                        window.showModal('ü•≥ –£—Å–ø–µ—Ö!', `${TRIAL_DAYS} –¥–Ω—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã! –í–∞—à –∫–ª—é—á VLESS –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Å–µ–∫—Ü–∏–∏ "–í–∞—à –°—Ç–∞—Ç—É—Å –∏ –ö–ª—é—á".`, '–ù–∞—á–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è');
                    } catch (error) {
                        console.error("–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞:", error);
                        window.showModal('–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏', `–ù–µ —É–¥–∞–ª–æ—Å—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥. ${error.message}`, '–û–ö');
                    }
                }
            );
        }

        // 4. –¢–∞—Ä–∏—Ñ—ã –∏ –û–ø–ª–∞—Ç–∞
        function renderTariffs() {
            const grid = document.getElementById('tariff-grid');
            grid.innerHTML = TARIFFS.map(t => `
                <div class="tariff-card">
                    <button class="btn" onclick="buySubscription(${t.months}, ${t.price})">
                        ${t.months} –º–µ—Å. <span class="btn-price">${t.price.toFixed(2).replace('.', ',')} ‚ÇΩ</span>
                        ${t.description ? `<span style="font-size:0.75em; opacity:0.8; margin-top: 2px;">(${t.description})</span>` : ''}
                    </button>
                </div>
            `).join('');
        }

        function buySubscription(months, price) {
            if (telegramId === 'NO_TG_ID' || telegramId === 'NO_TG_ID_DEV') {
                window.showModal('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à Telegram ID. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ Mini App —á–µ—Ä–µ–∑ –±–æ—Ç–∞.', '–û–ö');
                return;
            }

            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ YooMoney (–±–µ–∑ –∑–∞–ø—è—Ç—ã—Ö, —Ç–æ–ª—å–∫–æ —Ç–æ—á–∫–∞)
            const priceForPayment = price.toFixed(2);
            
            const comment = `–û–ø–ª–∞—Ç–∞_${months}–º–µ—Å_TGID_${telegramId}_${APP_NAME}`;
            const targets = `–û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏ Shinobu Proxy –Ω–∞ ${months} –º–µ—Å. (${priceForPayment} RUB)`;

            const yooMoneyUrl = `${YOOMONEY_QUICKPAY_URL}?` +
                `receiver=${YOOMONEY_RECIPIENT_ID}` +
                `&quickpay-form=shop` + 
                `&targets=${encodeURIComponent(targets)}` +
                `&sum=${priceForPayment}` +
                `&comment=${encodeURIComponent(comment)}` + 
                `&paymentType=AC`; 
                

            window.showModal('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã', `–í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ YooMoney –¥–ª—è –æ–ø–ª–∞—Ç—ã <strong>${priceForPayment.replace('.', ',')} ‚ÇΩ</strong> –∑–∞ ${months} –º–µ—Å—è—Ü–µ–≤. 
                <br><br><strong>–í–∞—à Telegram ID (${telegramId}) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø–ª–∞—Ç–µ–∂—É.</strong>
                <br>–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ —á–∞—Ç –±–æ—Ç–∞.`, 
                '–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ', 
                () => { 
                    window.openLink(yooMoneyUrl);
                    
                    // --- –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø: Mock-–ø–ª–∞—Ç–µ–∂ ---
                    window.showToast(`–ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω Mock-–ø–ª–∞—Ç–µ–∂. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –µ–≥–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å...`, 5000);
                    setTimeout(() => {
                        window.mockUpdateSubscription(telegramId, months);
                        window.showModal('üî• –ê–∫—Ç–∏–≤–∞—Ü–∏—è (–î–ï–ú–û)', `–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ ${months} –º–µ—Å—è—Ü–µ–≤ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞! (–í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç –ë–≠–ö–ï–ù–î)`, '–ì–æ—Ç–æ–≤–æ');
                    }, 5000);
                    // ------------------------------------
                }
            );
        }


        // 5. –ö–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
        function renderDownloadButtons() {
            const grid = document.getElementById('download-grid');
            grid.innerHTML = Object.keys(DOWNLOAD_LINKS).map(key => {
                const item = DOWNLOAD_LINKS[key];
                return `
                    <button class="btn" onclick="openLink('${item.url}')" title="–°–∫–∞—á–∞—Ç—å –¥–ª—è ${item.name}">
                        <span class="btn-icon">${item.icon}</span> ${item.name}
                    </button>
                `;
            }).join('');
        }

        function renderInstructionButtons() {
            const grid = document.getElementById('instructions-grid');
            grid.innerHTML = Object.keys(INSTRUCTION_LINKS).map(key => {
                const item = INSTRUCTION_LINKS[key];
                return `
                    <button class="btn" onclick="openLink('${item.url}')" title="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è ${item.name}">
                        <span class="btn-icon">${item.icon}</span> ${item.name}
                    </button>
                `;
            }).join('');
        }

        // –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å—Å—ã–ª–æ–∫
        window.openLink = function(url) {
            if (tg) {
                tg.openLink(url);
            } else {
                window.open(url, '_blank');
            }
        }

        // --- –£—Ç–∏–ª–∏—Ç—ã UI (–ó–∞–º–µ–Ω–∞ alert()/confirm()) ---
        
        // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        window.showModal = function(title, message, buttonText, callback = null) {
            const existingModal = document.getElementById('custom-modal-overlay');
            if (existingModal) existingModal.remove();

            const accentColor = (tg && tg.themeParams.link_color) ? tg.themeParams.link_color : 'var(--accent-color)';
            const buttonColor = (tg && tg.themeParams.button_color) ? tg.themeParams.button_color : 'var(--accent-color)';
            const buttonTextColor = (tg && tg.themeParams.button_text_color) ? tg.themeParams.button_text_color : '#000';
            
            const modalHtml = `
                <div id="custom-modal-overlay">
                    <div id="modal-content" style="border: 1px solid ${accentColor};">
                        <h3 style="font-size: 1.4em; margin-bottom: 15px; color: ${accentColor};">${title}</h3>
                        <p style="margin-bottom: 25px; line-height: 1.5; font-size: 0.95em;">${message}</p>
                        <button id="modal-action-btn" style="background: ${buttonColor}; color: ${buttonTextColor};">
                            ${buttonText}
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            document.getElementById('modal-action-btn').onclick = () => {
                document.getElementById('custom-modal-overlay').remove();
                if (callback) callback();
            };
        }
        
        // –ü–æ–∫–∞–∑ "—Ç–æ—Å—Ç–∞" (–í—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–Ω–∏–∑—É)
        window.showToast = function(message, duration = 3000) {
            const existingToast = document.querySelector('.custom-toast');
            if (existingToast) existingToast.remove(); // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π, –µ—Å–ª–∏ –µ—Å—Ç—å

            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = 'custom-toast';

            document.body.appendChild(toast);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—Å—Ç
            setTimeout(() => {
                toast.style.opacity = 1;
            }, 10);

            // –°–∫—Ä—ã–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Ç–æ—Å—Ç
            setTimeout(() => {
                toast.style.opacity = 0;
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

    </script>
</body>
</html>
