<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Shinobu Proxy - –¢–∞—Ä–∏—Ñ—ã –∏ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js?v=2.2"></script>
    <!-- Firebase Imports for Firestore -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // –í–ê–ñ–ù–û: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Ä–æ–≤–Ω—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ Firestore
        setLogLevel('debug');

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let userId = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                userId = auth.currentUser?.uid || crypto.randomUUID();
                
                console.log("Firebase initialized. User ID:", userId);
                
                // –ü–µ—Ä–µ–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–∫–æ—É–ø –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ <script>
                window.db = db;
                window.auth = auth;
                window.firebaseUserId = userId; 

                // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏
                window.startSubscriptionListener();

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", error);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                document.getElementById('status-info').innerHTML = 
                    `<span class="text-red-500">‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. ${error.message}</span>`;
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
        initializeFirebase();

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
        window.mockUpdateSubscription = async function(telegramId, months) {
            if (!db || !telegramId) return;

            const subscriptionRef = doc(db, `artifacts/${appId}/users/${userId}/subscription/status_doc`);
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            const docSnap = await getDoc(subscriptionRef);
            let expiryDate = new Date();
            if (docSnap.exists() && docSnap.data().status === 'active') {
                // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞, –ø—Ä–æ–¥–ª–µ–≤–∞–µ–º —Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã –∏—Å—Ç–µ—á–µ–Ω–∏—è
                expiryDate = docSnap.data().expiry_date.toDate();
            }
            
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–∞—Ç—É –∏—Å—Ç–µ—á–µ–Ω–∏—è –Ω–∞ N –º–µ—Å—è—Ü–µ–≤
            expiryDate.setMonth(expiryDate.getMonth() + months);
            
            const mockVlessLink = `vless://uuid-for-tg-${telegramId}-m${months}@server.shinobu.net:443?security=tls&fp=chrome&sni=server.shinobu.net#Shinobu_Proxy_${months}m`;

            const subscriptionData = {
                telegram_id: telegramId,
                status: 'active',
                expiry_date: expiryDate,
                vless_link: mockVlessLink,
                last_updated: serverTimestamp()
            };

            await setDoc(subscriptionRef, subscriptionData, { merge: true });
            console.log(`Mock subscription updated for ${telegramId} for ${months} months.`);
            // –ü—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —ç—Ç–æ –¥–æ–ª–∂–µ–Ω –¥–µ–ª–∞—Ç—å –≤–∞—à –±—ç–∫–µ–Ω–¥ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI —Å—Ä–∞–∑—É (onSnapshot —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
        }

    </script>
    
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #0d0d0d;
            --bg-light: #f5f7fa;
            --text-dark: #e0e0e0;
            --text-light: #2d3748;
            --accent-color: #00d4ff;
            --accent-dark: #00a8cc;
            --secondary-color: #7b2cbf;
            --card-dark: rgba(255, 255, 255, 0.03);
            --card-light: rgba(255, 255, 255, 0.9);
            --border-dark: rgba(0, 212, 255, 0.3);
            --border-light: rgba(0, 123, 255, 0.3);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-dark);
            color: var(--text-dark);
            min-height: 100vh;
            transition: background 0.5s ease, color 0.5s ease;
        }

        body.light-theme {
            background: var(--bg-light);
            color: var(--text-light);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
        header {
            text-align: center;
            padding: 30px 0 20px;
        }

        .logo {
            font-size: 2.2em;
            font-weight: bold;
            background: linear-gradient(45deg, var(--accent-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.3));
        }

        .tagline {
            font-size: 1em;
            color: #b0b0b0;
            margin-top: 5px;
        }

        body.light-theme .tagline {
            color: var(--text-light);
        }

        /* –û–±—â–∞—è —Å–µ–∫—Ü–∏—è */
        .section-title {
            font-size: 1.8em;
            color: var(--accent-color);
            margin: 30px 0 20px;
            border-bottom: 2px solid var(--border-dark);
            padding-bottom: 10px;
            text-align: center;
        }

        body.light-theme .section-title {
            color: #007bff;
            border-bottom-color: var(--border-light);
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∞ */
        .card {
            background: var(--card-dark);
            border: 1px solid var(--border-dark);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        body.light-theme .card {
            background: var(--card-light);
            border-color: var(--border-light);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        /* –ö–Ω–æ–ø–∫–∏ –∏ —Å–µ—Ç–∫–∏ */
        .grid {
            display: grid;
            gap: 15px;
        }

        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }

        .btn {
            padding: 12px 20px;
            background: rgba(0, 212, 255, 0.1);
            border: 2px solid var(--accent-color);
            color: var(--accent-color);
            text-decoration: none;
            font-size: 1em;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
        }

        body.light-theme .btn {
            background: rgba(0, 123, 255, 0.1);
            border-color: #007bff;
            color: #007bff;
        }

        .btn:hover {
            background: rgba(0, 212, 255, 0.25);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
            transform: translateY(-2px);
        }

        body.light-theme .btn:hover {
            background: rgba(0, 123, 255, 0.25);
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.4);
        }

        .btn-price {
            font-weight: bold;
            display: block;
            margin-top: 5px;
            font-size: 1.1em;
        }

        .tariff-card:nth-child(4) .btn { /* Best value (6 months) */
            background: linear-gradient(90deg, #7b2cbf, var(--accent-color));
            color: #fff;
            border-color: var(--secondary-color);
            box-shadow: 0 0 20px rgba(123, 44, 191, 0.5);
        }

        .tariff-card:nth-child(4) .btn:hover {
             background: linear-gradient(90deg, #6a24aa, var(--accent-dark));
        }
        
        /* –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ */
        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-indicator {
            padding: 5px 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.9em;
            transition: background 0.5s;
        }

        .status-inactive { background-color: #e53e3e; color: white; }
        .status-active { background-color: #38a169; color: white; }
        .status-loading { background-color: #3182ce; color: white; }

        .vless-link-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.9em;
            margin-top: 15px;
            border: 1px dashed var(--accent-color);
        }
        
        body.light-theme .vless-link-box {
            background: #e2e8f0;
            border-color: #3182ce;
        }

        .vless-container {
            display: flex;
            gap: 10px;
            align-items: stretch;
            margin-top: 15px;
        }

        .vless-copy-btn {
            flex-shrink: 0;
            padding: 10px 15px;
            font-size: 0.9em;
            background: #2b6cb0;
            border-color: #2b6cb0;
            color: white;
        }
        
        .vless-copy-btn:hover {
            background: #1e4e7c;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –∏ –æ—Ä–±—ã (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è —Å—Ç–∏–ª—è) */
        .grid-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 0;
            pointer-events: none;
        }
        .orb { position: fixed; border-radius: 50%; filter: blur(80px); opacity: 0.4; z-index: 0; pointer-events: none; }
        .orb1 { width: 400px; height: 400px; background: radial-gradient(circle, #00d4ff, transparent); top: -200px; left: -200px; }
        .orb2 { width: 500px; height: 500px; background: radial-gradient(circle, #7b2cbf, transparent); bottom: -250px; right: -250px; }
        body.light-theme .orb1 { background: radial-gradient(circle, rgba(0, 123, 255, 0.3), transparent); }
        body.light-theme .orb2 { background: radial-gradient(circle, rgba(99, 102, 241, 0.25), transparent); }
        
        /* –ú–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å—ã */
        @media (max-width: 600px) {
            .grid-4 { grid-template-columns: 1fr 1fr; }
            .grid-2 { grid-template-columns: 1fr; }
            .vless-container { flex-direction: column; }
            .vless-copy-btn { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Animated background -->
    <div class="grid-background"></div>
    <div class="orb orb1"></div>
    <div class="orb orb2"></div>

    <div class="container">
        <!-- Header -->
        <header>
            <div class="logo">üîí Shinobu Proxy</div>
            <div class="tagline">–í–∞—à–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å ‚Äî –Ω–∞—à –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</div>
            <div style="font-size: 0.8em; margin-top: 10px; opacity: 0.7;">
                –í–∞—à Telegram ID –¥–ª—è –æ–ø–ª–∞—Ç—ã: <span id="telegram-id-display">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
        </header>

        <!-- 1. –°—Ç–∞—Ç—É—Å –ü–æ–¥–ø–∏—Å–∫–∏ -->
        <section class="subscription-status-section">
            <h2 class="section-title">‚ú® –°—Ç–∞—Ç—É—Å –ü–æ–¥–ø–∏—Å–∫–∏</h2>
            <div class="card">
                <div class="status-header">
                    <h3>–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:</h3>
                    <div id="status-indicator" class="status-indicator status-loading">–ó–∞–≥—Ä—É–∑–∫–∞</div>
                </div>
                <div id="status-info" style="margin-top: 10px; line-height: 1.6;">
                    <p>–î–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è: <span id="expiry-date">...</span></p>
                    <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (Firebase ID): <span id="firebase-user-id">...</span></p>
                </div>

                <!-- –ë–ª–æ–∫ —Å VLESS-—Å—Å—ã–ª–∫–æ–π -->
                <div id="vless-container" class="vless-container" style="display: none;">
                    <div class="vless-link-box" id="vless-link-display" style="flex-grow: 1;">
                        VLESS-—Å—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å.
                    </div>
                    <button class="btn vless-copy-btn" onclick="copyVlessLink()">
                        üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
            </div>
        </section>

        <!-- 2. –¢–∞—Ä–∏—Ñ—ã –∏ –û–ø–ª–∞—Ç–∞ -->
        <section class="tariffs-section">
            <h2 class="section-title">üí≥ –¢–∞—Ä–∏—Ñ—ã –∏ –û–ø–ª–∞—Ç–∞ (YooMoney)</h2>
            <div class="grid grid-2" id="tariff-grid">
                <!-- –¢–∞—Ä–∏—Ñ—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã JS -->
            </div>
            <p style="text-align: center; font-size: 0.9em; margin-top: 15px; opacity: 0.8;">
                ‚ö†Ô∏è –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ YooMoney. –î–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–∂–¥–∞—Ç—å—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–∞ –±–æ—Ç–æ–º.
            </p>
        </section>

        <!-- 3. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
        <section class="connection-section">
            <h2 class="section-title">üì± –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</h2>

            <!-- –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π -->
            <h3 style="font-size: 1.3em; margin-bottom: 10px;">üì• –°–∫–∞—á–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h3>
            <div class="grid grid-4" id="download-grid">
                <!-- –ö–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã JS -->
            </div>

            <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
            <h3 style="font-size: 1.3em; margin-top: 20px; margin-bottom: 10px;">üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ</h3>
            <div class="grid grid-4" id="instructions-grid">
                <!-- –ö–Ω–æ–ø–∫–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã JS -->
            </div>
        </section>

    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let tg = null;
        let isInTelegram = false;
        let telegramId = null; // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram

        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –°–ï–†–í–ò–°–ê
        const YOOMONEY_RECIPIENT_ID = '4100118671234567'; // !!! –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ô ID –ö–û–®–ï–õ–¨–ö–ê YOOMONEY !!!
        const YOOMONEY_BASE_URL = `https://yoomoney.ru/to/${YOOMONEY_RECIPIENT_ID}`;
        const APP_NAME = 'Shinobu Proxy';

        const DOWNLOAD_LINKS = {
            android: { name: 'Android', icon: 'ü§ñ', url: 'https://github.com/2dust/v2rayNG/releases/download/1.10.23/v2rayNG_1.10.23_universal.apk' },
            ios: { name: 'iOS', icon: 'üçé', url: 'https://apps.apple.com/us/app/v2raytun/id6476628951' },
            android_tv: { name: 'Android TV', icon: 'üì∫', url: 'https://github.com/2dust/v2rayNG/releases/download/1.10.23/v2rayNG_1.10.23_universal.apk' },
            windows: { name: 'Windows', icon: 'ü™ü', url: 'https://github.com/hiddify/hiddify-app/releases/download/v2.0.5/Hiddify-Windows-Portable-x64.zip' }
        };

        const INSTRUCTION_LINKS = {
            android: { name: 'Android', icon: 'üìñ', url: 'https://telegra.ph/Kak-podklyuchitsya-k-Proxy-10-13' },
            ios: { name: 'iOS', icon: 'üìñ', url: 'https://telegra.ph/Kak-podklyuchitsya-k-Proxy-10-13-5' },
            android_tv: { name: 'Android TV', icon: 'üìñ', url: 'https://telegra.ph/Kak-podklyuchitsya-k-Proxy-10-13-4' },
            windows: { name: 'Windows', icon: 'üìñ', url: 'https://telegra.ph/Kak-podklyuchitsya-k-Proxy-10-13-3' }
        };

        const TARIFFS = [
            { months: 1, price: 150 },
            { months: 2, price: 280, description: '–í—ã–≥–æ–¥–Ω–æ! –°–∫–∏–¥–∫–∞ 20‚ÇΩ' },
            { months: 3, price: 400, description: '–õ—É—á—à–∞—è —Ü–µ–Ω–∞! –°–∫–∏–¥–∫–∞ 50‚ÇΩ' },
            { months: 6, price: 700, description: '–°—É–ø–µ—Ä-—ç–∫–æ–Ω–æ–º–∏—è! –°–∫–∏–¥–∫–∞ 200‚ÇΩ' }
        ];

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ UI —Ñ—É–Ω–∫—Ü–∏–∏ ---

        window.addEventListener('load', function() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
            if (window.Telegram && window.Telegram.WebApp) {
                tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                tg.setHeaderColor(tg.themeParams.bg_color || '#0d0d0d');
                tg.setBackgroundColor(tg.themeParams.bg_color || '#0d0d0d');

                isInTelegram = tg.initData !== '';
                
                if (tg.initDataUnsafe.user) {
                    telegramId = tg.initDataUnsafe.user.id;
                    document.getElementById('telegram-id-display').textContent = telegramId;
                } else {
                    document.getElementById('telegram-id-display').textContent = 'ID –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω (–Ω–µ –≤ Telegram WebApp)';
                    telegramId = 'NO_TG_ID';
                }
            } else {
                console.warn('Telegram WebApp API –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.');
                telegramId = 'NO_TG_ID_DEV';
                document.getElementById('telegram-id-display').textContent = `${telegramId} (DEV)`;
            }

            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–Ω–æ–ø–æ–∫
            renderTariffs();
            renderDownloadButtons();
            renderInstructionButtons();
            
            // –ï—Å–ª–∏ Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è (–æ–Ω –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ type="module"),
            // –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–ó–∞–≥—Ä—É–∑–∫–∞" –¥–æ –µ–≥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏.
            document.getElementById('firebase-user-id').textContent = window.firebaseUserId || '–û–∂–∏–¥–∞–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏...';
        });
        
        // –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Firebase
        window.startSubscriptionListener = function() {
            const userId = window.firebaseUserId;
            document.getElementById('firebase-user-id').textContent = userId;
            
            if (!window.db || !userId || telegramId === 'NO_TG_ID') {
                document.getElementById('status-info').innerHTML = 
                    `<span class="text-red-500">‚ùå –û—à–∏–±–∫–∞: –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å. (TG ID: ${telegramId})</span>`;
                return;
            }

            const subscriptionRef = doc(window.db, `artifacts/${window.appId}/users/${userId}/subscription/status_doc`);
            
            // onSnapshot –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            onSnapshot(subscriptionRef, (docSnap) => {
                const indicator = document.getElementById('status-indicator');
                const info = document.getElementById('status-info');
                const vlessContainer = document.getElementById('vless-container');
                const vlessLinkDisplay = document.getElementById('vless-link-display');

                if (docSnap.exists() && docSnap.data().status === 'active') {
                    const data = docSnap.data();
                    const expiryDate = data.expiry_date.toDate();
                    const formattedDate = expiryDate.toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric' });
                    
                    indicator.textContent = '–ê–∫—Ç–∏–≤–Ω–∞ ‚úÖ';
                    indicator.className = 'status-indicator status-active';
                    info.innerHTML = `
                        <p>–î–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è: <span id="expiry-date">${formattedDate}</span></p>
                        <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (Firebase ID): ${userId}</p>
                    `;

                    vlessLinkDisplay.textContent = data.vless_link;
                    vlessContainer.style.display = 'flex';
                } else {
                    indicator.textContent = '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞ ‚ùå';
                    indicator.className = 'status-indicator status-inactive';
                    info.innerHTML = `
                        <p>–î–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è: <span id="expiry-date">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏</span></p>
                        <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (Firebase ID): ${userId}</p>
                    `;
                    vlessContainer.style.display = 'none';
                }
            }, (error) => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏:", error);
                document.getElementById('status-info').innerHTML = 
                    `<span class="text-red-500">‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å. ${error.message}</span>`;
            });
        }
        
        // --- –õ–æ–≥–∏–∫–∞ –ö–Ω–æ–ø–æ–∫ ---

        // 1. –¢–∞—Ä–∏—Ñ—ã –∏ –û–ø–ª–∞—Ç–∞
        function renderTariffs() {
            const grid = document.getElementById('tariff-grid');
            grid.innerHTML = TARIFFS.map(t => `
                <div class="tariff-card">
                    <button class="btn" onclick="buySubscription(${t.months}, ${t.price})">
                        ${t.months} –º–µ—Å. <span class="btn-price">${t.price} ‚ÇΩ</span>
                        ${t.description ? `<span style="font-size:0.75em; opacity:0.8;">(${t.description})</span>` : ''}
                    </button>
                </div>
            `).join('');
        }

        function buySubscription(months, price) {
            if (YOOMONEY_RECIPIENT_ID === 'YOUR_YOOMONEY_ACCOUNT_ID') {
                showModal('–û—à–∏–±–∫–∞', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–º–µ–Ω–∏—Ç–µ "YOUR_YOOMONEY_ACCOUNT_ID" –≤ –∫–æ–¥–µ –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π ID –∫–æ—à–µ–ª—å–∫–∞ YooMoney.', '–û–ö');
                return;
            }

            if (telegramId === 'NO_TG_ID') {
                showModal('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à Telegram ID. –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.', '–û–ö');
                return;
            }

            const comment = `–û–ø–ª–∞—Ç–∞_${months}–º–µ—Å_TGID_${telegramId}_${APP_NAME}`;
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã YooMoney
            const yooMoneyUrl = `${YOOMONEY_BASE_URL}?amount=${price}&comment=${encodeURIComponent(comment)}`;

            showModal('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã', `–í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ YooMoney –¥–ª—è –æ–ø–ª–∞—Ç—ã ${price} ‚ÇΩ –∑–∞ ${months} –º–µ—Å—è—Ü–µ–≤. 
                <br><br><strong>–í–∞—à Telegram ID (${telegramId}) –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø–ª–∞—Ç–µ–∂—É –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.</strong>
                <br>–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ —á–∞—Ç –±–æ—Ç–∞.`, 
                '–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ', 
                () => { 
                    window.open(yooMoneyUrl, '_blank'); 
                    // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Å–æ–æ–±—â–∞–µ–º –±–æ—Ç—É, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª –æ–ø–ª–∞—Ç—É
                    // if (tg) tg.sendData(JSON.stringify({ action: 'purchase_attempt', months: months, amount: price }));
                }
            );
            
            // --- –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–£–î–ê–õ–ò–¢–ï –í –†–ï–ê–õ–¨–ù–û–ú –ü–†–û–î–ê–ö–®–ï–ù–ï) ---
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —ç—Ç–æ –¥–æ–ª–∂–µ–Ω –¥–µ–ª–∞—Ç—å –≤–∞—à –ë–≠–ö–ï–ù–î –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è Webhook –æ—Ç YooMoney.
            // –ó–¥–µ—Å—å —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã UI –∏ Firestore.
            /*
            setTimeout(() => {
                window.mockUpdateSubscription(telegramId, months);
                showModal('Mock: –ê–∫—Ç–∏–≤–∞—Ü–∏—è', `[–î–ï–ú–û] –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ ${months} –º–µ—Å—è—Ü–µ–≤ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞! (–≠—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –Ω–∞ –≤–∞—à–µ–º –ë–≠–ö–ï–ù–î–ï!)`, '–ì–æ—Ç–æ–≤–æ');
            }, 3000);
            */
            // -----------------------------------------------------------------------------------
        }


        // 2. –ö–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        function renderDownloadButtons() {
            const grid = document.getElementById('download-grid');
            grid.innerHTML = Object.keys(DOWNLOAD_LINKS).map(key => {
                const item = DOWNLOAD_LINKS[key];
                return `
                    <button class="btn" onclick="openLink('${item.url}')" title="–°–∫–∞—á–∞—Ç—å –¥–ª—è ${item.name}">
                        ${item.icon} ${item.name}
                    </button>
                `;
            }).join('');
        }

        // 3. –ö–Ω–æ–ø–∫–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
        function renderInstructionButtons() {
            const grid = document.getElementById('instructions-grid');
            grid.innerHTML = Object.keys(INSTRUCTION_LINKS).map(key => {
                const item = INSTRUCTION_LINKS[key];
                return `
                    <button class="btn" onclick="openLink('${item.url}')" style="font-size: 0.9em;" title="–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è ${item.name}">
                        ${item.icon} –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (${item.name})
                    </button>
                `;
            }).join('');
        }

        // –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å—Å—ã–ª–æ–∫
        function openLink(url) {
            if (tg) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é Telegram Web App –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤–Ω–µ—à–Ω–∏—Ö —Å—Å—ã–ª–æ–∫
                tg.openLink(url);
            } else {
                // –ï—Å–ª–∏ –Ω–µ –≤ Web App, –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
                window.open(url, '_blank');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è VLESS-—Å—Å—ã–ª–∫–∏
        function copyVlessLink() {
            const link = document.getElementById('vless-link-display').textContent;
            
            // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ document.execCommand('copy') –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å iframe
            const textarea = document.createElement('textarea');
            textarea.value = link;
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
            } catch (err) {
                console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç:', err);
                showModal('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é.', '–û–ö');
            }
            
            document.body.removeChild(textarea);
        }

        // --- –£—Ç–∏–ª–∏—Ç—ã UI (–ó–∞–º–µ–Ω–∞ alert()/confirm()) ---
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (–¥–ª—è showModal)
        function createModalElement(title, message, buttonText, callback) {
            const modalHtml = `
                <div id="custom-modal-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 10000; display: flex; justify-content: center; align-items: center;">
                    <div style="background: ${tg ? tg.themeParams.secondary_bg_color : '#1a1a2e'}; padding: 25px; border-radius: 12px; max-width: 350px; width: 90%; text-align: center; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5); border: 1px solid ${tg ? tg.themeParams.link_color : 'var(--accent-color)'}; color: ${tg ? tg.themeParams.text_color : 'var(--text-dark)'};">
                        <h3 style="font-size: 1.4em; margin-bottom: 15px; color: ${tg ? tg.themeParams.link_color : 'var(--accent-color)'};">${title}</h3>
                        <p style="margin-bottom: 25px; line-height: 1.5; font-size: 0.95em;">${message}</p>
                        <button id="modal-action-btn" style="padding: 10px 20px; background: ${tg ? tg.themeParams.button_color : 'var(--accent-color)'}; color: ${tg ? tg.themeParams.button_text_color : '#000'}; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background 0.2s;">
                            ${buttonText}
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            document.getElementById('modal-action-btn').onclick = () => {
                document.getElementById('custom-modal-overlay').remove();
                if (callback) callback();
            };
        }

        // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function showModal(title, message, buttonText, callback = null) {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –æ–∫–Ω–æ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
            const existingModal = document.getElementById('custom-modal-overlay');
            if (existingModal) existingModal.remove();

            createModalElement(title, message, buttonText, callback);
        }
        
        // –ü–æ–∫–∞–∑ "—Ç–æ—Å—Ç–∞" (–Ω–µ–Ω–∞–≤—è–∑—á–∏–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ)
        function showToast(message, duration = 3000) {
            if (tg && tg.showPopup) {
                 // –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–æ–¥–Ω–æ–π pop-up Telegram (–±–æ–ª–µ–µ –Ω–∞—Ç–∏–≤–Ω–æ)
                 tg.showPopup({
                    title: '',
                    message: message,
                    buttons: [{ type: 'ok', text: 'OK' }]
                }, () => {});
                return;
            }

            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 10px 20px;
                border-radius: 8px;
                z-index: 10001;
                opacity: 0;
                transition: opacity 0.3s ease-in-out;
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = 1;
            }, 10);

            setTimeout(() => {
                toast.style.opacity = 0;
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

    </script>
</body>
</html>
